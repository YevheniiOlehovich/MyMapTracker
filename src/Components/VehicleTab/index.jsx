import React, { useMemo, useState } from 'react';
import { useDispatch } from 'react-redux';
import { useVehiclesData, useDeleteVehicle } from '../../hooks/useVehiclesData';
import { useGroupsData } from '../../hooks/useGroupsData';
import {
    createColumnHelper,
    getCoreRowModel,
    getSortedRowModel,
    getFilteredRowModel,
    useReactTable,
    flexRender,
} from '@tanstack/react-table';
import { openAddVehicleModal } from '../../store/modalSlice';
import Styles from './styled';
import Button from '../Button';
import EditIco from '../../assets/ico/edit-icon-black.png';
import DelIco from '../../assets/ico/del-icon-black.png';
import { vehicleTypes } from '../../helpres';

export default function VehiclesTab() {
    const dispatch = useDispatch();

    const { data: vehicles = [], isLoading, isError, error } = useVehiclesData();
    const { data: groups = [] } = useGroupsData();
    const deleteVehicle = useDeleteVehicle();

    const [globalFilter, setGlobalFilter] = useState('');
    const [sorting, setSorting] = useState([]);

    const columnHelper = createColumnHelper();

    // –ú–∞–ø–∞ groupId => –Ω–∞–∑–≤–∞ –≥—Ä—É–ø–∏
    const groupMap = useMemo(() => {
        return groups.reduce((acc, group) => {
        acc[group._id] = group.name;
        return acc;
        }, {});
    }, [groups]);

    // –ú–∞–ø–∞ vehicleTypeId => –Ω–∞–∑–≤–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é
    const vehicleTypeMap = useMemo(() => {
        return vehicleTypes.reduce((acc, vt) => {
        acc[vt._id] = vt.name;
        return acc;
        }, {});
    }, []);

    const handleAdd = () => {
        dispatch(openAddVehicleModal({}));
    };

    const handleEdit = (vehicleId) => {
        dispatch(openAddVehicleModal({ vehicleId }));
    };

    const handleDelete = (vehicleId) => {
        if (window.confirm('–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏–π –∑–∞—Å—ñ–±?')) {
        deleteVehicle.mutate(vehicleId, {
            onError: (err) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ:', err);
            alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
            },
        });
        }
    };

    const columns = useMemo(() => [
        {
        id: 'rowNumber',
        header: '#',
        cell: info => info.row.index + 1,
        },
        columnHelper.accessor(row => groupMap[row.groupId] || '‚Äî', {
        id: 'groupName',
        header: '–ì—Ä—É–ø–∞',
        enableGlobalFilter: true,
        }),
        columnHelper.accessor('mark', {
        header: '–ú–∞—Ä–∫–∞',
        enableGlobalFilter: true,
        cell: info => info.getValue() || '‚Äî',
        }),
        columnHelper.accessor('regNumber', {
        header: '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä',
        enableGlobalFilter: true,
        cell: info => info.getValue() || '‚Äî',
        }),
        columnHelper.accessor(row => vehicleTypeMap[row.vehicleType] || '‚Äî', {
        id: 'vehicleType',
        header: '–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É',
        enableGlobalFilter: false,
        }),
        columnHelper.accessor('imei', {
        header: 'IMEI',
        enableGlobalFilter: true,
        cell: info => info.getValue() || '‚Äî',
        }),
        columnHelper.accessor('note', {
        header: '–ü—Ä–∏–º—ñ—Ç–∫–∞',
        enableGlobalFilter: false,
        cell: info => info.getValue() || '‚Äî',
        }),
        {
        id: 'actions',
        header: '–î—ñ—ó',
        cell: info => (
            <div style={{ display: 'flex', gap: 8 }}>
            <Styles.button onClick={() => handleEdit(info.row.original._id)} title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                <Styles.ico $pic={EditIco} />
            </Styles.button>
            <Styles.button onClick={() => handleDelete(info.row.original._id)} title="–í–∏–¥–∞–ª–∏—Ç–∏">
                <Styles.ico $pic={DelIco} />
            </Styles.button>
            </div>
        ),
        },
    ], [handleEdit, handleDelete, groupMap, vehicleTypeMap]);

    const table = useReactTable({
        data: vehicles,
        columns,
        state: {
        globalFilter,
        sorting,
        },
        onGlobalFilterChange: setGlobalFilter,
        onSortingChange: setSorting,
        getCoreRowModel: getCoreRowModel(),
        getSortedRowModel: getSortedRowModel(),
        getFilteredRowModel: getFilteredRowModel(),
    });

    if (isLoading) return <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>;
    if (isError) return <div>–ü–æ–º–∏–ª–∫–∞: {error.message}</div>;

    return (
        <Styles.wrapper>
            <Styles.header>
                <Styles.searchInput
                    type="text"
                    placeholder="–ü–æ—à—É–∫ –ø–æ –≥—Ä—É–ø—ñ, –º–∞—Ä—Ü—ñ, —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó..."
                    value={globalFilter}
                    onChange={e => setGlobalFilter(e.target.value)}
                    />
                    <Button text="–î–æ–¥–∞—Ç–∏" onClick={handleAdd} />
            </Styles.header>

            <Styles.tableContainer>
                <Styles.table>
                <thead>
                    {table.getHeaderGroups().map(headerGroup => (
                    <tr key={headerGroup.id}>
                        {headerGroup.headers.map(header => (
                        <th
                            key={header.id}
                            onClick={header.column.getToggleSortingHandler()}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                        >
                            {flexRender(header.column.columnDef.header, header.getContext())}
                            {header.column.getIsSorted() === 'asc' ? ' üîº' : header.column.getIsSorted() === 'desc' ? ' üîΩ' : ''}
                        </th>
                        ))}
                    </tr>
                    ))}
                </thead>
                <tbody>
                    {table.getRowModel().rows.map(row => (
                    <tr key={row.id}>
                        {row.getVisibleCells().map(cell => (
                        <td key={cell.id}>
                            {flexRender(cell.column.columnDef.cell, cell.getContext())}
                        </td>
                        ))}
                    </tr>
                    ))}
                </tbody>
                </Styles.table>
            </Styles.tableContainer>
        </Styles.wrapper>
    );
}
